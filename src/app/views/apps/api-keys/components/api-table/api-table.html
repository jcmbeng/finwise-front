<div class="card">
    <div class="card-header border-light justify-content-between">
        <div class="d-flex gap-2">
            <div class="app-search">
                <input [(ngModel)]="tableService.searchTerm" type="text" class="form-control"
                       placeholder="Search API clients...">
                <ng-icon name="tablerSearch" class="app-search-icon text-muted"/>
            </div>
            @if (hasSelection) {
                <button class="btn btn-danger" (click)="deleteSelected()">Delete</button>
            }
            <button type="submit" class="btn btn-secondary btn-icon" (click)="openApiModal(content)">
                <ng-icon
                    name="tablerPlus" class="fs-lg"/>
            </button>
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="me-2 fw-semibold">Filter By:</span>

            <div class="app-search">
                <select [(ngModel)]="filterStatus" (ngModelChange)="tableService.setFilter('status', filterStatus)"
                        class="form-select form-control my-1 my-md-0">
                    <option value="All">Status</option>
                    <option value="Active">Active</option>
                    <option value="Pending">Pending</option>
                    <option value="Revoked">Revoked</option>
                    <option value="Suspended">Suspended</option>
                    <option value="Expired">Expired</option>
                </select>
                <lucide-angular [img]="LucideCircleCheck" class="app-search-icon text-muted"/>
            </div>

            <div class="app-search">
                <select [(ngModel)]="filterByRegion" (ngModelChange)="tableService.setFilter('region', filterByRegion)"
                        class="form-select form-control my-1 my-md-0">
                    <option value="All">Region</option>
                    <option value="US">USA</option>
                    <option value="UK">UK</option>
                    <option value="IN">India</option>
                    <option value="DE">Germany</option>
                    <option value="AU">Australia</option>
                </select>
                <lucide-angular [img]="LucideGlobe" class="app-search-icon text-muted"/>
            </div>

            <div>
                <select [(ngModel)]="tableService.pageSize" class="form-select form-control my-1 my-md-0">
                    <option [ngValue]="8">8</option>
                    <option [ngValue]="10">10</option>
                    <option [ngValue]="15">15</option>
                    <option [ngValue]="20">20</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-custom table-centered table-hover w-100 mb-0">
            <thead class="bg-light bg-opacity-25 thead-sm">
            <tr class="text-uppercase fs-xxs">
                <th scope="col" style="width: 1%;">
                    <input class="form-check-input form-check-input-light fs-14 mt-0" data-table-select-all
                           type="checkbox" value="option" [(ngModel)]="selectAll" (change)="toggleAllSelection()">
                </th>
                @for (col of columns; track $index) {
                    <th [sortable]="col"
                        (sort)="tableService.setSort($event.column, $event.direction)">
                        {{ col }}
                    </th>
                }

                <th class="text-center">Actions</th>
            </tr>
            </thead>
            <tbody>
                @if ((total$ | async)! > 0) {
                    @for (item of records$ | async; track $index) {
                        <tr>
                            <td><input [(ngModel)]="item.selected" (change)="toggleSingleSelection()" type="checkbox"
                                       class="form-check-input form-check-input-light fs-14 mt-0"/></td>
                            <td class="fw-medium">{{ item.name }}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <img
                                        [src]="item.avatar"
                                        class="avatar avatar-xs rounded-circle"
                                        alt="avatar"
                                    />
                                    <h5 class="fs-sm mb-0 lh-base">{{ item.author }}</h5>
                                </div>
                            </td>
                            <td>
                                <div class="input-group">
                                    <input class="form-control form-control-sm" readonly [value]="item.apiKey"/>
                                    <button
                                        class="btn btn-sm btn-icon btn-light"
                                        (click)="copyToClipboard(item.apiKey)"
                                    >
                                        <ng-icon name="tablerCopy" class="fs-lg"/>
                                    </button>
                                </div>
                            </td>
                            <td>
            <span
                [class]="
                  item.status === 'pending' ? 'bg-warning-subtle text-warning' :
                  (item.status === 'revoked' || item.status === 'suspended') ? 'bg-danger-subtle text-danger' :
                  item.status === 'trial' ? 'bg-info-subtle text-info' :
                  item.status === 'expired' ? 'bg-secondary-subtle text-secondary' : 'bg-success-subtle text-success'
                "
                class="badge badge-label"

            >
              {{ toTitleCase(item.status) }}
            </span>
                            </td>
                            <td>{{ item.created }}</td>
                            <td>{{ item.expiryDate }}</td>
                            <td>
            <span class="badge p-1 text-bg-light fs-sm">
              <img
                  [src]="item.regionFlag"
                  class="rounded-circle me-1"
                  height="12"
                  alt=""
              />
                {{ item.region }}
            </span>
                            </td>
                            <td>
                                <div class="d-flex justify-content-center gap-1">
                                    <button class="btn btn-default btn-icon btn-sm">
                                        <ng-icon name="tablerEye" class="fs-lg"/>
                                    </button>
                                    <button class="btn btn-default btn-icon btn-sm">
                                        <ng-icon name="tablerEdit" class="fs-lg"/>
                                    </button>
                                    <button class="btn btn-default btn-icon btn-sm"
                                            (click)="tableService.deleteItem(item)">
                                        <ng-icon name="tablerTrash" class="fs-lg"/>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                } @else {
                    <tr class="no-results">
                        <td colspan="11" class="text-center text-muted py-3">Nothing found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="card-footer border-0">
        @if ((total$ | async)! > 0) {
            <app-custom-pagination
                itemsName="apis"
                [showingRange]="tableService.showingRange"
                [collectionSize]="(total$ | async)!"
                [(page)]="tableService.page"
                [pageSize]="tableService.pageSize"
            >
            </app-custom-pagination>
        }
    </div>
</div>

<ng-template #content let-modal>

    <div class="modal-header">
        <h5 class="modal-title" id="addApiKeyModalLabel">Add New API Key</h5>
        <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>

    <form>
        <div class="modal-body">
            <div class="row g-3">

                <div class="col-md-6">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-control" placeholder="Enter client name">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Created By</label>
                    <select class="form-select">
                        <option selected disabled>Select user</option>
                        <option>Mark Reynolds</option>
                        <option>Sophia Turner</option>
                        <option>Liam Watson</option>
                        <option>Ava Turner</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">API Key</label>
                    <div class="input-group">
                        <input type="text" id="apiKeyInput" class="form-control"
                               placeholder="Enter or generate API key">
                        <button type="button" class="btn btn-secondary" onclick="generateApiKey()">Generate</button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <select class="form-select">
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Revoked">Revoked</option>
                        <option value="Suspended">Suspended</option>
                        <option value="Trial">Trial</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Usage Limit</label>
                    <input type="text" class="form-control" placeholder="e.g. 1000">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Region</label>
                    <select class="form-select">
                        <option value="DE">🇩🇪 Germany</option>
                        <option value="UK">🇬🇧 UK</option>
                        <option value="IN">🇮🇳 India</option>
                        <option value="US">🇺🇸 USA</option>
                        <option value="AU">🇦🇺 Australia</option>
                        <option value="CA">🇨🇦 Canada</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Created On</label>
                    <input type="date" mwlFlatpickr [options]="{dateFormat: 'd M, Y'}" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Expires On</label>
                    <input type="date" mwlFlatpickr [options]="{dateFormat: 'd M, Y'}" class="form-control">
                </div>

            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-light" (click)="modal.dismiss()">Cancel</button>
            <button type="submit" class="btn btn-primary">Add API Key</button>
        </div>
    </form>
</ng-template>
